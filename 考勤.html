<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMSI è€ƒå‹¤ç™»è®° - é©¬å¾·é‡Œå›½é™…ä¸­æ–‡å­¦æ ¡</title>
    <style>
        /* --- æ ¸å¿ƒè§†è§‰é£æ ¼ --- */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'PingFang SC', sans-serif;
            background-color: #f5f7fa; 
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .header {
            background-color: white;
            text-align: center;
            padding: 35px 20px 0 20px;
            border-bottom: 5px solid #f1c40f; 
        }

        .header h1 {
            color: #1a4a8e; 
            font-size: 36px;
            margin: 0;
            letter-spacing: 2px;
        }

        .header h1 span { font-weight: 800; margin-right: 12px; }

        .header .subtitle {
            color: #6b7280; 
            font-size: 18px;
            margin: 8px 0 20px 0;
        }

        /* --- é¡¶éƒ¨æ§åˆ¶æ  --- */
        .toolbar {
            width: 100%;
            max-width: 1100px;
            margin: 20px auto;
            display: flex;
            gap: 15px;
            padding: 0 20px;
            box-sizing: border-box;
            align-items: flex-start;
        }

        /* å¤åˆ»è¿”å›æŒ‰é’® */
        .btn-home {
            display: inline-flex;
            align-items: center;
            padding: 10px 25px;
            background-color: white;
            color: #1a4a8e;
            text-decoration: none;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
            white-space: nowrap;
        }
        .btn-home::before { content: "â†"; margin-right: 10px; font-weight: bold; }

        .mgmt-card {
            background: white;
            flex: 1;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .input-group { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        
        .label-text { font-weight: bold; color: #334155; min-width: 80px; }

        input, select {
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            outline: none;
            font-size: 14px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-blue { background: #1a4a8e; color: white; }
        .btn-orange { background: #f39c12; color: white; }
        .btn-green { background: #27ae60; color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        /* --- è€ƒå‹¤è¡¨æ ¼åŒº --- */
        .main-content { flex: 1; padding: 0 20px 40px 20px; display: flex; justify-content: center; }
        
        .attendance-container {
            width: 100%;
            max-width: 1100px;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        .class-section { margin-bottom: 40px; }

        .class-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
            padding: 12px 20px;
            border-left: 6px solid #f1c40f;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .class-name { font-size: 20px; font-weight: 800; color: #1a4a8e; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: #64748b; font-size: 14px; padding: 12px; border-bottom: 2px solid #edf2f7; }
        td { padding: 15px 12px; border-bottom: 1px solid #f1f5f9; }

        .status-options { display: flex; gap: 15px; }
        label { font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 4px; color: #475569; }

        .tag { font-size: 11px; padding: 2px 8px; border-radius: 12px; margin-left: 8px; font-weight: 600; }
        .tag-fixed { background: #dbeafe; color: #1e40af; }
        .tag-temp { background: #fef3c7; color: #92400e; }

        .btn-del { color: #ef4444; font-size: 13px; cursor: pointer; text-decoration: underline; }

        .empty-state { text-align: center; color: #94a3b8; padding: 60px 0; font-size: 18px; }

        .footer { background: #1a4a8e; color: white; text-align: center; padding: 20px; font-size: 14px; }
    </style>
</head>
<body>

    <header class="header">
        <h1><span>EMSI</span> é©¬å¾·é‡Œå›½é™…ä¸­æ–‡å­¦æ ¡</h1>
        <div class="subtitle">å­¦ç”Ÿç­çº§è€ƒå‹¤ç®¡ç†ç³»ç»Ÿ (GestiÃ³n de Asistencia)</div>
    </header>

    <div class="toolbar">
        <a href="index.html" class="btn-home">è¿”å›é¦–é¡µ</a>
        
        <div class="mgmt-card">
            <div class="input-group">
                <span class="label-text">1. ç­çº§å:</span>
                <input type="text" id="newClassName" placeholder="ä¾‹å¦‚ï¼šä¸€å¹´çº§Aç­">
                <button class="btn btn-orange" onclick="addClass()">+ åˆ›å»ºç­çº§</button>
            </div>

            <div class="input-group">
                <span class="label-text">2. åŠ å­¦ç”Ÿ:</span>
                <input type="text" id="newStuName" placeholder="å­¦ç”Ÿå§“å" style="width: 140px;">
                <select id="targetClass"></select>
                <select id="stuType">
                    <option value="å›ºå®šç­çº§">ğŸ¢ å›ºå®šç­çº§</option>
                    <option value="ä¸´æ—¶å­¦ç”Ÿ">ğŸŒŸ ä¸´æ—¶å­¦ç”Ÿ</option>
                </select>
                <button class="btn btn-blue" onclick="addStudent()">ç¡®è®¤æ·»åŠ </button>
                
                <div style="margin-left: auto; display: flex; gap: 10px;">
                    <button class="btn btn-green" onclick="manualSave()">ğŸ’¾ ä¿å­˜æ•°æ®</button>
                    <button class="btn btn-blue" style="background:#475569" onclick="exportCSV()">ğŸ“¥ å¯¼å‡ºæŠ¥è¡¨</button>
                </div>
            </div>
        </div>
    </div>

    <main class="main-content">
        <div class="attendance-container" id="mainDisplay">
            </div>
    </main>

    <footer class="footer">
        Â© 2026 EMSI é©¬å¾·é‡Œå›½é™…ä¸­æ–‡å­¦æ ¡ | EducaciÃ³n para un futuro mejor
    </footer>

    <script>
        // --- æ•°æ®æ ¸å¿ƒ ---
        // ä½¿ç”¨å”¯ä¸€çš„é”®åï¼Œé˜²æ­¢æ•°æ®å†²çª
        const STORAGE_KEY = 'EMSI_ATTENDANCE_DATABASE_2026';
        
        let db = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
            classes: [],
            students: []
        };

        // --- åˆå§‹åŒ– ---
        function init() {
            renderAll();
        }

        // --- ç­çº§æ“ä½œ ---
        function addClass() {
            const name = document.getElementById('newClassName').value.trim();
            if (!name) return alert("è¯·è¾“å…¥ç­çº§åç§°");
            if (db.classes.includes(name)) return alert("ç­çº§å·²å­˜åœ¨");
            
            db.classes.push(name);
            autoSave();
            document.getElementById('newClassName').value = '';
            renderAll();
        }

        function deleteClass(className) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤ [${className}] å—ï¼Ÿ\nè¯¥ç­çº§ä¸‹çš„å­¦ç”Ÿä¹Ÿä¼šè¢«åŒæ­¥ç§»é™¤ã€‚`)) {
                db.classes = db.classes.filter(c => c !== className);
                db.students = db.students.filter(s => s.className !== className);
                autoSave();
                renderAll();
            }
        }

        // --- å­¦ç”Ÿæ“ä½œ ---
        function addStudent() {
            const name = document.getElementById('newStuName').value.trim();
            const className = document.getElementById('targetClass').value;
            const type = document.getElementById('stuType').value;

            if (!name) return alert("è¯·è¾“å…¥å­¦ç”Ÿå§“å");
            if (!className) return alert("è¯·å…ˆåˆ›å»ºä¸€ä¸ªç­çº§");

            db.students.push({
                id: Date.now(),
                name: name,
                className: className,
                type: type,
                status: 'å‡ºå¸­' // é»˜è®¤å€¼
            });

            // æ’åºï¼šå…ˆæŒ‰ç±»å‹ï¼Œå†æŒ‰åå­—æ‹¼éŸ³
            db.students.sort((a, b) => {
                if (a.type !== b.type) return a.type === "å›ºå®šç­çº§" ? -1 : 1;
                return a.name.localeCompare(b.name, 'zh');
            });

            autoSave();
            document.getElementById('newStuName').value = '';
            document.getElementById('newStuName').focus();
            renderAll();
        }

        function removeStudent(id) {
            db.students = db.students.filter(s => s.id !== id);
            autoSave();
            renderAll();
        }

        function updateStatus(id, newStatus) {
            const student = db.students.find(s => s.id === id);
            if (student) student.status = newStatus;
            autoSave();
        }

        // --- ä¿å­˜é€»è¾‘ ---
        function autoSave() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
        }

        function manualSave() {
            autoSave();
            alert("âœ… æ•°æ®å·²å®‰å…¨ä¿å­˜è‡³æœ¬åœ°å­˜å‚¨ï¼");
        }

        // --- æ¸²æŸ“å¼•æ“ ---
        function renderAll() {
            const display = document.getElementById('mainDisplay');
            const selector = document.getElementById('targetClass');
            
            // 1. æ›´æ–°ç­çº§ä¸‹æ‹‰æ¡†
            selector.innerHTML = db.classes.map(c => `<option value="${c}">${c}</option>`).join('');

            // 2. æ›´æ–°ä¸»è€ƒå‹¤è¡¨
            if (db.classes.length === 0) {
                display.innerHTML = `
                    <div class="empty-state">
                        <p>ğŸ“¢ è¿˜æ²¡æœ‰ç­çº§æ•°æ®</p>
                        <p style="font-size:14px; color:#cbd5e1">è¯·åœ¨ä¸Šæ–¹ç¬¬ä¸€æ­¥è¾“å…¥ç­çº§åç§°å¹¶ç‚¹å‡»â€œåˆ›å»ºç­çº§â€</p>
                    </div>`;
                return;
            }

            let html = '';
            db.classes.forEach(cls => {
                const classStus = db.students.filter(s => s.className === cls);
                
                html += `
                <div class="class-section">
                    <div class="class-header">
                        <span class="class-name">ğŸ“ ${cls} (${classStus.length}äºº)</span>
                        <span class="btn-del" onclick="deleteClass('${cls}')">åˆ é™¤æ­¤ç­çº§</span>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th style="width:25%">å­¦ç”Ÿå§“å</th>
                                <th style="width:65%">è€ƒå‹¤çŠ¶æ€</th>
                                <th style="width:10%">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${classStus.map(s => `
                                <tr>
                                    <td>
                                        <strong>${s.name}</strong>
                                        <span class="tag ${s.type === 'å›ºå®šç­çº§' ? 'tag-fixed' : 'tag-temp'}">${s.type}</span>
                                    </td>
                                    <td>
                                        <div class="status-options">
                                            ${['å‡ºå¸­', 'æœªå‡ºå¸­', 'è¯·å‡', 'å›ºå®šä¸æ¥'].map(opt => `
                                                <label>
                                                    <input type="radio" name="status-${s.id}" value="${opt}" 
                                                    ${s.status === opt ? 'checked' : ''} 
                                                    onchange="updateStatus(${s.id}, '${opt}')"> ${opt}
                                                </label>
                                            `).join('')}
                                        </div>
                                    </td>
                                    <td><span class="btn-del" onclick="removeStudent(${s.id})">ç§»é™¤</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`;
            });
            display.innerHTML = html;
        }

        // --- å¯¼å‡ºæŠ¥è¡¨ ---
        function exportCSV() {
            if (db.students.length === 0) return alert("ç›®å‰æ²¡æœ‰å­¦ç”Ÿè€ƒå‹¤æ•°æ®å¯å¯¼å‡º");
            
            const today = new Date().toLocaleDateString();
            let csv = "\uFEFFç­çº§,å­¦ç”Ÿå§“å,ç±»å‹,ä»Šæ—¥çŠ¶æ€,ç™»è®°æ—¥æœŸ\n";
            
            db.students.forEach(s => {
                csv += `${s.className},${s.name},${s.type},${s.status},${today}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `EMSIè€ƒå‹¤æ±‡æ€»_${today.replace(/\//g, '-')}.csv`;
            link.click();
        }

        // ç›‘å¬å›è½¦é”®æ·»åŠ 
        document.getElementById('newStuName').addEventListener('keypress', e => { if(e.key === 'Enter') addStudent(); });

        init();
    </script>
</body>
</html>