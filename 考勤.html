<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMSI è€ƒå‹¤ç³»ç»Ÿ</title>
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background-color: #f5f7fa; display: flex; flex-direction: column; min-height: 100vh; }
        .header { background-color: white; text-align: center; padding: 30px 20px 10px; border-bottom: 5px solid #f1c40f; }
        .header h1 { color: #1a4a8e; font-size: 32px; margin: 0; }
        .header h1 span { font-weight: 800; }
        .toolbar { width: 100%; max-width: 1100px; margin: 20px auto; display: flex; gap: 15px; padding: 0 20px; box-sizing: border-box; }
        .btn-home { display: inline-flex; align-items: center; padding: 10px 20px; background: white; color: #1a4a8e; text-decoration: none; border-radius: 50px; font-weight: 600; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 1px solid #ddd; }
        .mgmt-card { background: white; flex: 1; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 10px; }
        .input-group { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        input, select { padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
        .btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; color: white; }
        .btn-blue { background: #1a4a8e; }
        .btn-orange { background: #f39c12; }
        .btn-green { background: #27ae60; }
        .main-content { flex: 1; padding: 0 20px 40px; display: flex; justify-content: center; }
        .attendance-container { width: 100%; max-width: 1100px; }
        .class-section { background: white; margin-bottom: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; }
        .class-header { background: #f8fafc; padding: 15px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-left: 6px solid #f1c40f; }
        .class-name { font-size: 18px; font-weight: bold; color: #1a4a8e; }
        .class-content { display: block; padding: 10px 20px; }
        .collapsed-content { display: none; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 10px; border-bottom: 2px solid #eee; font-size: 14px; }
        td { padding: 12px 10px; border-bottom: 1px solid #f9f9f9; }
        .tag { font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 5px; }
        .tag-fixed { background: #e1effe; color: #1e429f; }
        .tag-temp { background: #fef3c7; color: #92400e; }
        .footer { background: #1a4a8e; color: white; text-align: center; padding: 15px; }
    </style>
</head>
<body>
    <header class="header">
        <h1><span>EMSI</span> è€ƒå‹¤ç®¡ç†ç³»ç»Ÿ</h1>
    </header>
    <div class="toolbar">
        <a href="index.html" class="btn-home">â† é¦–é¡µ</a>
        <div class="mgmt-card">
            <div class="input-group">
                <input type="text" id="newClassName" placeholder="ç­çº§å">
                <button class="btn btn-orange" onclick="addClass()">åˆ›å»ºç­çº§</button>
            </div>
            <div class="input-group">
                <input type="text" id="newStuName" placeholder="å§“å">
                <select id="targetClass"></select>
                <select id="stuType"><option value="å›ºå®šç­çº§">ğŸ¢ å›ºå®š</option><option value="ä¸´æ—¶å­¦ç”Ÿ">ğŸŒŸ ä¸´æ—¶</option></select>
                <button class="btn btn-blue" onclick="addStudent()">æ·»åŠ å­¦ç”Ÿ</button>
                <button class="btn btn-green" onclick="manualSave()">ğŸ’¾ ä¿å­˜</button>
                <button class="btn btn-blue" onclick="exportCSV()">ğŸ“¥ å¯¼å‡º</button>
            </div>
        </div>
    </div>
    <main class="main-content"><div class="attendance-container" id="mainDisplay"></div></main>
    <script>
        const STORAGE_KEY = 'EMSI_ATTENDANCE_V3';
        let db = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { classes: [], students: [], collapsed: [] };

        function renderAll() {
            const display = document.getElementById('mainDisplay');
            const selector = document.getElementById('targetClass');
            selector.innerHTML = db.classes.map(c => `<option value="${c}">${c}</option>`).join('');
            if (db.classes.length === 0) { display.innerHTML = '<p style="text-align:center;color:#999">è¯·å…ˆåˆ›å»ºç­çº§</p>'; return; }
            let html = '';
            db.classes.forEach(cls => {
                const isCollapsed = db.collapsed.includes(cls);
                const classStus = db.students.filter(s => s.className === cls);
                html += `
                <div class="class-section">
                    <div class="class-header" onclick="toggleCollapse('${cls}')">
                        <span class="class-name">${isCollapsed ? 'â–¶' : 'â–¼'} ${cls} (${classStus.length}äºº)</span>
                        <button class="btn" style="color:red;font-size:12px;background:none" onclick="deleteClass(event, '${cls}')">åˆ é™¤ç­çº§</button>
                    </div>
                    <div class="class-content ${isCollapsed ? 'collapsed-content' : ''}">
                        <table>
                            ${classStus.map(s => `
                            <tr>
                                <td>${s.name}<span class="tag ${s.type==='å›ºå®šç­çº§'?'tag-fixed':'tag-temp'}">${s.type}</span></td>
                                <td>${['å‡ºå¸­', 'æœªå‡ºå¸­', 'è¯·å‡', 'å›ºå®šä¸æ¥'].map(opt => `
                                    <label style="margin-right:8px"><input type="radio" name="s-${s.id}" value="${opt}" ${s.status===opt?'checked':''} onchange="updateStatus(${s.id},'${opt}')">${opt}</label>
                                `).join('')}</td>
                                <td><button onclick="removeStudent(${s.id})" style="border:none;background:none;color:red;cursor:pointer">Ã—</button></td>
                            </tr>`).join('')}
                        </table>
                    </div>
                </div>`;
            });
            display.innerHTML = html;
        }

        function addClass() { const n = document.getElementById('newClassName').value.trim(); if(n && !db.classes.includes(n)) { db.classes.push(n); save(); document.getElementById('newClassName').value=''; renderAll(); } }
        function deleteClass(e, n) { e.stopPropagation(); if(confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ')) { db.classes = db.classes.filter(c => c!==n); db.students = db.students.filter(s => s.className!==n); save(); renderAll(); } }
        function toggleCollapse(n) { if(db.collapsed.includes(n)) db.collapsed = db.collapsed.filter(c=>c!==n); else db.collapsed.push(n); save(); renderAll(); }
        function addStudent() { const n = document.getElementById('newStuName').value.trim(); const c = document.getElementById('targetClass').value; const t = document.getElementById('stuType').value; if(n && c) { db.students.push({id:Date.now(), name:n, className:c, type:t, status:'å‡ºå¸­'}); save(); document.getElementById('newStuName').value=''; renderAll(); } }
        function updateStatus(id, s) { const stu = db.students.find(x=>x.id===id); if(stu) stu.status = s; save(); }
        function removeStudent(id) { db.students = db.students.filter(x=>x.id!==id); save(); renderAll(); }
        function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }
        function manualSave() { save(); alert('ä¿å­˜æˆåŠŸï¼'); }
        function exportCSV() { let csv = "\uFEFFç­çº§,å§“å,çŠ¶æ€\n"; db.students.forEach(s => csv += `${s.className},${s.name},${s.status}\n`); const blob = new Blob([csv], {type:'text/csv'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'è€ƒå‹¤.csv'; a.click(); }
        renderAll();
    </script>
</body>
</html>